PROCESS APOST.
IDENTIFICATION DIVISION.
PROGRAM-ID. IBMTEST3.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SOURCE-COMPUTER.  IBM-AS400.
OBJECT-COMPUTER.  IBM-AS400.
SPECIAL-NAMES.
C01           IS  NEW-PAGE
LOCAL-DATA    IS  LDA
I-O-FEEDBACK  IS  IO-DATA
OPEN-FEEDBACK IS  OF-DATA.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
DATA DIVISION.
FILE SECTION.

WORKING-STORAGE SECTION.
01  SAVE-EQUIP-INIT-NBR         PIC X(10).
01  SAVE-RECLAIM-CODE           PIC XX.
01  SAVE-TRIP-CONTROL-NBR       PIC 9(09).
    COPY SY101CBGL IN QCPYSRC.
01  GL101-GENERAL-GLOSSARY.
    05  GL101-SWITCH-VALUES.
        10  GL101-YES              PIC X(01)      VALUE 'Y'.
        10  GL101-NO               PIC X(01)      VALUE 'N'.
    05  GL101-INDICATOR-VALUES.
        10  GL101-INDIC-ON         PIC 1          VALUE B'1'.
        10  GL101-INDIC-OFF        PIC 1          VALUE B'0'.
    05  GL101-SCREEN-STATUS.
        10  GL101-SS-F3            PIC X(03)      VALUE 'F3 '.
        10  GL101-SS-F12           PIC X(03)      VALUE 'F12'.
    05  GL101-LOGICAL-VIEWS.
        10  GL101-LV-L01           PIC X(03)      VALUE 'L01'.
        10  GL101-LV-L02           PIC X(03)      VALUE 'L02'.
        10  GL101-LV-L03           PIC X(03)      VALUE 'L03'.
        10  GL101-LV-L04           PIC X(03)      VALUE 'L04'.

    COPY SY102CBGL IN QCPYSRC.
01  GL102-DBIO-GLOSSARY.
    05  GL102-IO-COMMANDS.
        10  GL102-IO-READ           PIC X(03)      VALUE 'R  '.
        10  GL102-IO-READ-1ST       PIC X(03)      VALUE 'RF '.
        10  GL102-IO-READ-LAST      PIC X(03)      VALUE 'RL '.
        10  GL102-IO-READ-NEXT      PIC X(03)      VALUE 'RN '.
        10  GL102-IO-READ-PREV      PIC X(03)      VALUE 'RP '.
        10  GL102-IO-ADD            PIC X(03)      VALUE 'A  '.
        10  GL102-IO-UPDATE         PIC X(03)      VALUE 'U  '.
        10  GL102-IO-DELETE         PIC X(03)      VALUE 'D  '.
        10  GL102-IO-OPEN-IO        PIC X(03)      VALUE 'OIO'.
        10  GL102-IO-OPEN-INPUT     PIC X(03)      VALUE 'OI '.
        10  GL102-IO-CLOSE          PIC X(03)      VALUE 'C  '.
        10  GL102-IO-READ-SERIES    PIC X(03)      VALUE 'RS '.
        10  GL102-IO-READ-LOCKED    PIC X(03)      VALUE 'RK '.
        10  GL102-IO-READ-NEXT-LOCKED
                                    PIC X(03)      VALUE 'RNK'.
    05  GL102-FILE-STATUS.
        10  GL102-FS-NO-IO          PIC X(02)      VALUE '  '.
        10  GL102-FS-STATUS-OK      PIC X(02)      VALUE '00'.
        10  GL102-FS-EOF            PIC X(02)      VALUE '10'.
        10  GL102-FS-NOT-FOUND      PIC X(02)      VALUE '23'.
    05  GL102-RETURN-STATUS.
        10  GL102-RS-NORMAL         PIC 9(02)      VALUE 00.
        10  GL102-RS-BAD-COMMAND    PIC 9(02)      VALUE 01.
        10  GL102-RS-BAD-CLOSE      PIC 9(02)      VALUE 02.
        10  GL102-RS-BAD-SEG-ID     PIC 9(02)      VALUE 03.
        10  GL102-RS-IO-FAILURE     PIC 9(02)      VALUE 04.
        10  GL102-RS-FILE-NOT-OPEN  PIC 9(02)      VALUE 05.
        10  GL102-RS-NO-IO          PIC 9(02)      VALUE 99.
    05  GL102-SWITCH-VALUES.
        10  GL102-SV-OPEN           PIC X(01)      VALUE 'O'.
        10  GL102-SV-CLOSE          PIC X(01)      VALUE 'C'.

PROCEDURE DIVISION USING LS-PHASE.

0000-MAIN-LOGIC   SECTION.
PROGRAM-ENTRY.
    CALL 'IOCHP01L1R' USING CHP01-SYSTEM-OPTIONS.
    IF  CHP01-ABORTED-IN-PGM NOT = SPACES
        GO TO PROGRAM-EXIT.

    IF  CHP01-MODS-EFFECTIVE-MONTH NOT = SPACES
    AND CHP01-SERVICE-MONTH < CHP01-MODS-EFFECTIVE-MONTH
        SET  UTCHP01-RETRIEVE-HIST TO TRUE
    ELSE
        SET  UTCHP01-RETRIEVE-CURR TO TRUE
    END-IF.

    SET  UTCHP01-NO-ERROR TO TRUE
    CALL 'UTCHP01' USING UTCHP01-ACTION,
                         UTCHP01-STATUS,
                         CHP01-SYSTEM-OPTIONS.

    PERFORM 1000-HOUSEKEEPING.
    PERFORM 2000-PROCESSING-LOOP
            UNTIL LK101-FS-EOF.
    PERFORM 9900-CLOSE-FILES.
    CALL 'IOCHP01L1U' USING CHP01-SYSTEM-OPTIONS.
    IF  LS-PHASE-1
        IF  CHP01-TOL-PARTICIPANT
            IF  (CHP01-TR-VOLUNTARY)
            OR  (CHP01-TP-ESTIMATE)
                CALL 'UTCHPRCLM2'.
    IF  LS-PHASE-1
        IF  D93-MAX-RECLAIM
            CALL 'UTCHPRCLM5'.
PROGRAM-EXIT.
    GOBACK.

1000-HOUSEKEEPING      SECTION.
SECTION-ENTRY.
    MOVE '1000-HOUSEKEEPING' TO LK991-SECTION.

    SET  UTCHPRCLM3-NOT-CALLED TO TRUE.
    MOVE SPACES                TO LK-UTCHP02-DIRECTOR.

    IF  LS-PHASE-1
    OR  LS-PHASE-2
        NEXT SENTENCE
    ELSE
        MOVE 'MISSING PHASE'  TO LK991-COMMENT-1
        GO TO 9999-ABORT-ROUTINE.
    INITIALIZE CHP05-CYCLE-HEADER
               CHP07-EQUIP-MOVEMENT-HISTORY
               LCS57-EQUIP-MOVEMENT-EVENT
              PREV57-EQUIP-MOVEMENT-EVENT
            B4PREV57-EQUIP-MOVEMENT-EVENT
               PREV-CYCLE-HEADER
               LAST-CYCLE-HEADER
               WANT-CYCLE-HEADER
               CHP05SD-CYCLE-HEADER
               D94-INDX
               CHP82-TRIP-INFO.
    MOVE GL102-FS-NO-IO TO LK101-FILE-STATUS.
    PERFORM 9800-OPEN-FILES.
    INITIALIZE CHP02-PROCESS-ERROR
              PREV02-PROCESS-ERROR.
    MOVE CHP01-USER-ROAD      TO CHP02-USER-ROAD.
    MOVE CHP01-BEG-CYCLE-CONTROL-NBR
                              TO CHP02-BEG-CYCLE-CONTROL-NBR.
    MOVE CHP01-SERVICE-MONTH  TO CHP02-SERVICE-MONTH.
    MOVE CHP01-DISP-SERVICE-MONTH
                              TO CHP02-DISP-SERVICE-MONTH.
    IF  NOT LS-PHASE-1
        GO TO 1000-50-CONTD.
    INITIALIZE CHP20-RECLAIM-MASTER
    MOVE CHP01-USER-ROAD    TO CHP20-USER-ROAD
    MOVE GL102-IO-READ-NEXT TO LK101-IO-COMMAND
    PERFORM 9450-DBIO
       UNTIL LK101-FS-EOF
          OR CHP20-RECLAIM-CODE-EXT = 'MAX '.
    IF  LK101-FS-EOF
        MOVE '  ' TO LK101-FILE-STATUS
    ELSE
        MOVE CHP20-RECLAIM-CODE-EXT
          TO   D93-RECLAIM-CODE-EXT.
1000-50-CONTD.
    INITIALIZE CHP20-RECLAIM-MASTER
    MOVE CHP01-USER-ROAD    TO CHP20-USER-ROAD
    MOVE GL102-IO-READ-NEXT TO LK101-IO-COMMAND
    PERFORM 9400-DBIO.
    IF  LK101-FS-EOF
        MOVE 'N' TO D99-GO-NOGO-IND.
    MOVE CHP01-USER-ROAD TO CHP05-USER-ROAD
                            CHP82-USER-ROAD.
    MOVE GL102-IO-READ-NEXT TO LK101-IO-COMMAND.
    PERFORM 9000-DBIO.
    MOVE 'O' TO UTCHPTTX-STATUS
    CALL 'UTCHPTTX' USING CHP05-CYCLE-HEADER
                          CHP20-RECLAIM-MASTER
                          CHP01-SYSTEM-OPTIONS
                          UTCHPTTX-PROGRAM
                          UTCHPTTX-STATUS.
    MOVE ' ' TO UTCHPTTX-STATUS.
SECTION-EXIT.
    EXIT.


3300-GET-RECLAIM               SECTION.
SECTION-ENTRY.
    MOVE '3300-GET-RECLAIM'     TO LK991-SECTION.
    INITIALIZE CHP20-RECLAIM-MASTER.
    MOVE CHP01-USER-ROAD        TO CHP20-USER-ROAD.
    MOVE CHP05-RECLAIM-CODE     TO CHP20-RECLAIM-CODE.
    MOVE CHP05-RECLAIM-CODE-EXT TO CHP20-RECLAIM-CODE-EXT.
3300-20-READ-RECLAIM-MASTER.
    MOVE GL102-IO-READ-NEXT     TO LK101-IO-COMMAND.
    PERFORM 9300-DBIO.
    IF  NOT LK101-FS-STATUS-OK
        INITIALIZE CHP20-RECLAIM-MASTER
        MOVE SPACES TO LK101-FILE-STATUS
        GO TO SECTION-EXIT.
    IF  CHP20-RECLAIM-CODE     > CHP05-RECLAIM-CODE
        GO TO SECTION-EXIT.
    IF  CHP20-RECLAIM-CODE     = CHP05-RECLAIM-CODE
    AND CHP20-RECLAIM-CODE-EXT > CHP05-RECLAIM-CODE-EXT
        GO TO SECTION-EXIT.
    IF  CHP20-EFFECTIVE-MONTH > CHP01-SERVICE-MONTH
        INITIALIZE CHP20-RECLAIM-MASTER
        GO TO SECTION-EXIT.
    IF  CHP20-EXPIRE-MONTH    < CHP01-SERVICE-MONTH
        GO TO 3300-20-READ-RECLAIM-MASTER.
SECTION-EXIT.
    EXIT.

3400-DETECT-TOL-FAILURE        SECTION.
SECTION-ENTRY.
    MOVE '3400-FAILURE'         TO LK991-SECTION.
    IF  (CHP01-TR-VOLUNTARY)
    OR  (CHP01-TP-ESTIMATE)
        NEXT SENTENCE
    ELSE
        GO TO SECTION-EXIT.
    INITIALIZE CHP07-EQUIP-MOVEMENT-HISTORY.
    MOVE CHP01-USER-ROAD    TO CHP07-USER-ROAD.
    MOVE CHP05-TRIP-CONTROL-NBR
                            TO CHP07-TRIP-CONTROL-NBR
                                 D95-TRIP-CONTROL-NBR.
    MOVE SPACES             TO LK101-FILE-STATUS.
    MOVE GL102-IO-READ-NEXT TO LK101-IO-COMMAND.
    PERFORM 9250-DBIO.
    IF  (CHP05-RECLAIM-CODE-EXT NOT = SPACES)
    AND (CHP05-RELOAD)
        PERFORM UNTIL (LK101-FS-EOF)
                   OR (CHP07-TRIP-CONTROL-NBR NOT =
                                     D95-TRIP-CONTROL-NBR)
                   OR (CHP07-DS-TOL-RULE5-RECEIVABLE  AND
                       CHP07-DELIVERY)
                PERFORM 9250-DBIO
        END-PERFORM
    ELSE
        PERFORM UNTIL (LK101-FS-EOF)
                   OR (CHP07-TRIP-CONTROL-NBR NOT =
                                     D95-TRIP-CONTROL-NBR)
                   OR (CHP07-DS-TOL-RULE5-RECEIVABLE)
                PERFORM 9250-DBIO
        END-PERFORM.
    IF  LK101-FS-EOF
        GO TO 3400-50-FAILED.
    IF  CHP07-TRIP-CONTROL-NBR NOT =
                                 D95-TRIP-CONTROL-NBR
        GO TO 3400-50-FAILED.
    GO TO SECTION-EXIT.
